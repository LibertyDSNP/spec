<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Factory - DSNP Specification</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "coal" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 800) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <a id="logo" href="https://www.dsnp.org/">
                    DSNP
                </a>
                <ol class="chapter"><li class="chapter-item affix "><a href="../index.html">Introduction</a></li><li class="chapter-item affix "><a href="../Roadmap.html">Roadmap</a></li><li class="chapter-item "><a href="../DSNP/Overview.html">DSNP</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../DSNP/Identity.html">Identity</a></li><li class="chapter-item "><a href="../DSNP/Identifiers.html">Identifiers</a></li><li class="chapter-item "><a href="../DSNP/Graph.html">Graph</a></li><li class="chapter-item "><a href="../DSNP/BatchPublications.html">Batch Publications</a></li><li class="chapter-item "><a href="../DSNP/Announcements.html">Announcements</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../DSNP/Types/Tombstone.html">Tombstone</a></li><li class="chapter-item "><a href="../DSNP/Types/GraphChange.html">Graph Change</a></li><li class="chapter-item "><a href="../DSNP/Types/Broadcast.html">Broadcast</a></li><li class="chapter-item "><a href="../DSNP/Types/Reply.html">Reply</a></li><li class="chapter-item "><a href="../DSNP/Types/Reaction.html">Reaction</a></li><li class="chapter-item "><a href="../DSNP/Types/Profile.html">Profile</a></li><li class="chapter-item "><a href="../DSNP/Types/Update.html">Update</a></li></ol></li><li class="chapter-item "><a href="../DSNP/Serializations.html">Serializations</a></li></ol></li><li class="chapter-item expanded "><a href="../Implementations.html">DSNP Implementation Specs</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Ethereum/Overview.html">EVM</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Ethereum/Identity.html">Identity</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../Ethereum/Identifiers.html">Identifiers</a></li><li class="chapter-item expanded "><a href="../Ethereum/IdentityFactory.html" class="active">Factory</a></li><li class="chapter-item "><a href="../Ethereum/Registry.html">Registry</a></li></ol></li><li class="chapter-item "><a href="../Ethereum/Publishing.html">Publishing</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../Ethereum/Validation.html">Validation</a></li></ol></li></ol></li></ol></li><li class="chapter-item "><a href="../ActivityContent/Overview.html">Activity Content</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../ActivityContent/Types/Note.html">Note</a></li><li class="chapter-item "><a href="../ActivityContent/Types/Profile.html">Profile</a></li><li class="chapter-item "><div>Associated Type</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../ActivityContent/Associated/Hash.html">Hash</a></li><li class="chapter-item "><a href="../ActivityContent/Associated/Location.html">Location</a></li><li class="chapter-item "><a href="../ActivityContent/Associated/Tag.html">Tag</a></li><li class="chapter-item "><a href="../ActivityContent/Associated/Attachments.html">Attachments</a></li></ol></li></ol></li><li class="chapter-item "><a href="../Reference/Glossary.html">Glossary</a></li><li class="chapter-item "><div>Draft Specifications</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../Draft/Archivists.html">Archivists</a></li></ol></li></ol>
                <div class="spacer"></div>
                <a href="https://www.dsnp.org/developer-portal/" class="nav-return">↩ Developer Portal</a>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Dark</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">DSNP Specification</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/LibertyDSNP/spec" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/LibertyDSNP/spec/blob/main/pages/Ethereum/IdentityFactory.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Type to search..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="identity-factory"><a class="header" href="#identity-factory">Identity Factory</a></h1>
<p>The least expensive way to create a new identity is through an identity factory.
Official contracts will provide one or more of these standard interfaces to easily generate an identity with different upgrade paths.</p>
<p><strong>Remember:</strong> Using a factory or even a proxy is just an optimization and <em>NOT</em> required.
Any contract that matches the <a href="Identity.html">DSNP Identity</a> interfaces is valid.</p>
<h2 id="purpose"><a class="header" href="#purpose">Purpose</a></h2>
<ol>
<li>Describe how an Identity Factory can create an identity.</li>
<li>Describe how an Identity Factory can allow someone else to pay for the creation an identity.</li>
<li>Restrict the creation of identities without owner permission.</li>
</ol>
<h2 id="assumptions"><a class="header" href="#assumptions">Assumptions</a></h2>
<ul>
<li>All assumptions from <a href="Identity.html">DSNP Identity</a></li>
</ul>
<h2 id="proxy-contracts"><a class="header" href="#proxy-contracts">Proxy Contracts</a></h2>
<p>While it is not required, most of the DSNP Identity compatible contracts are proxy contracts.
Proxy contracts are often created through a factory contract.
Here are the interfaces to be a DSNP-compatible identity factory.</p>
<h3 id="what-is-a-proxy-contract"><a class="header" href="#what-is-a-proxy-contract">What is a Proxy Contract?</a></h3>
<p>Proxy contracts are used to limit the gas for deploying many contracts that all have the same logic, but need different state.
The state is maintained at the &quot;proxy&quot; contract while the logic to alter the state is able to be in one &quot;logic&quot; contract.</p>
<p><strong>Remember: A Logic Contract has 100% control over the state of a smart contract.</strong>
While a logic contract cannot have state that effects the execution of a proxy contract,
a logic contract's code can be written in such a way that allows for others to take control of a contract.
Never use logic contracts that you do not trust!</p>
<h3 id="what-are-the-different-types-of-proxy-contracts"><a class="header" href="#what-are-the-different-types-of-proxy-contracts">What are the different types of Proxy Contracts?</a></h3>
<p><a href="https://docs.openzeppelin.com/contracts/4.x/api/proxy">OpenZeppelin</a> has a great set of standard and audited proxy contracts.</p>
<p>While there may not be an identity factory interface for each type, the documentation from OpenZeppelin gives good detail on the differences between the types.</p>
<h3 id="can-i-switch-from-one-type-to-another"><a class="header" href="#can-i-switch-from-one-type-to-another">Can I switch from one type to another?</a></h3>
<p>Switching types is possible, but difficult.
See <a href="Registry.html">Identity Registry</a> for more information on changing an identity contract to another type.</p>
<h3 id="data-storage-and-eip-1967"><a class="header" href="#data-storage-and-eip-1967">Data storage and EIP 1967</a></h3>
<p>Due to the state management system that Ethereum uses, it can easily cause issues for upgradable contracts.
<a href="https://eips.ethereum.org/EIPS/eip-1967">EIP 1967</a> provides for ways to safely use state that will not collide.
Implementations of upgradable proxies MUST use EIP 1967 style data storage.</p>
<h3 id="logic-contract-constraints"><a class="header" href="#logic-contract-constraints">Logic Contract Constraints</a></h3>
<p>Contracts that are used as the logic for the proxy are not able to use constructors for initialization.
Proxy contracts however can have constructors and additionally the factory can be used to call methods once the proxy is created.
Remember that setting up the initial authorization state of a contract MUST be done in a single transaction to prevent others sniping the contract.</p>
<h2 id="factory"><a class="header" href="#factory">Factory</a></h2>
<p>An identity factory will give easy methods to allow for the creation of proxy contracts that function as DSNP Identities.
Official implementation contract addresses will be published once deployed.</p>
<h3 id="clone-interface"><a class="header" href="#clone-interface">Clone Interface</a></h3>
<p>Clones follow <a href="https://eips.ethereum.org/EIPS/eip-1167">EIP 1167</a> for a <strong>non-upgradable</strong> identity contract.</p>
<pre><code class="language-solidity">/**
 * @dev DSNP Identity Factory Interface for creating identities via [EIP 1167](https://eips.ethereum.org/EIPS/eip-1167)
 */
interface IIdentityCloneFactory {

    /**
     * @dev event to log the created proxy contract address
     */
    event ProxyCreated(address addr);

    /**
     * @dev Creates a new identity with the message sender as the owner
     * @dev [EIP 1167](https://eips.ethereum.org/EIPS/eip-1167) Proxy
     * @param logic The address to use for the logic contract
     *
     * @dev This MUST emit ProxyCreated with the address of the new proxy contract
     * @return The address of the newly created proxy contract
     */
    function createCloneProxy(address logic) public returns (address);

    /**
     * @dev Creates a new identity with the ecrecover address as the owner
     * @dev [EIP 1167](https://eips.ethereum.org/EIPS/eip-1167) Proxy
     * @param logic The address to use for the logic contract
     * @param owner The initial owner's address of the new contract
     *
     * @dev This MUST emit ProxyCreated with the address of the new proxy contract
     * @return The address of the newly created proxy contract
     */
    function createCloneProxyWithOwner(address logic, address owner) external returns (address);
}
</code></pre>
<h3 id="upgradable-proxy-interface"><a class="header" href="#upgradable-proxy-interface">Upgradable Proxy Interface</a></h3>
<p>Upgradable Proxies can be upgraded by the owner or permissioned delegates.</p>
<pre><code class="language-solidity">/**
 * @dev DSNP Identity Factory Interface for creating upgradable identities
 */
interface IIdentityUpgradableFactory {

    /**
     * @dev event to log the created proxy contract address
     */
    event ProxyCreated(address addr);

    /**
     * @dev Logs updates to the suggested logic contract
     * @dev MUST BE emitted when the contract changes the suggested logic address
     * @param newLogic The new address
     */
    event LogicUpdated(address newLogic);

    /**
     * @dev This may be upgradable by the owner of the factory
     *
     * @return The current logic contract suggested by this factory
     */
    function getLogic() external view returns (address);

    /**
     * @dev Creates a new identity with the message sender as the owner
     *      and will be pointed at the default logic address.
     *
     * @dev This MUST emit ProxyCreated with the address of the new proxy contract
     * @return The address of the newly created proxy contract
     */
    function createUpgradableProxy() external returns (address);

    /**
     * @dev Creates a new identity with the message sender as the owner
     * @param logic The address to use for the logic contract
     *
     * @dev This MUST emit ProxyCreated with the address of the new proxy contract
     * @return The address of the newly created proxy contract
     */
    function createUpgradableProxy(address logic) external returns (address);

    /**
     * @dev Creates a new identity with the ecrecover address as the owner
     * @param logic The logic address to use for identity creation
     * @param owner The initial owner's address of the new contract
     *
     * @dev This MUST emit ProxyCreated with the address of the new proxy contract
     * @return The address of the newly created proxy contract
     */
    function createUpgradableProxyWithOwner(address logic, address owner) external returns (address);
}
</code></pre>
<h3 id="beacon-factory-interface"><a class="header" href="#beacon-factory-interface">Beacon Factory Interface</a></h3>
<p>Beacon Proxies will use the beacon's logic address and will be upgraded when the beacon's logic address is changed.
This is the suggested factory for use on Betanet to remain up to date.</p>
<pre><code class="language-solidity">/**
 * @dev DSNP Identity Factory Interface for creating beacon following identities
 */
interface IIdentityBeaconFactory {

    /**
     * @dev event to log the created proxy contract address
     */
    event ProxyCreated(address addr);

    /**
     * @dev This MUST NOT be upgradable by the owner of the factory
     *
     * @return The current beacon contract suggested by this factory
     */
    function getBeacon() external view returns (address);

    /**
     * @dev Creates a new identity with the message sender as the owner
     *      Uses the beacon defined by getBeacon()
     *
     * @dev This MUST emit ProxyCreated with the address of the new proxy contract
     * @return The address of the newly created proxy contract
     */
    function createBeaconProxy() external returns (address);

    /**
     * @dev Creates a new identity with the message sender as the owner
     * @param beacon The beacon address to use for logic contract resolution
     *
     * @dev This MUST emit ProxyCreated with the address of the new proxy contract
     * @return The address of the newly created proxy contract
     */
    function createBeaconProxy(address beacon) external returns (address);

    /**
     * @dev Creates a new identity with the ecrecover address as the owner
     * @param beacon The beacon address to use logic contract resolution
     * @param owner The initial owner's address of the new contract
     *
     * @dev This MUST emit ProxyCreated with the address of the new proxy contract
     * @return The address of the newly created proxy contract
     */
    function createBeaconProxyWithOwner(address beacon, address owner) external returns (address);

    /**
     * @dev Creates a new identity with the address as the owner and registers it with a handle
     * @param beacon The beacon address to use logic contract resolution
     * @param owner The initial owner's address of the new contract
     * @param handle The handle the new identity proxy under which should be registered
     *
     * @dev This MUST emit ProxyCreated with the address of the new proxy contract
     * @dev This MUST revert if registration reverts
     * @dev This MUST emit a DSNPRegistryUpdate
     */
    function createAndRegisterBeaconProxy(
        address beacon,
        address owner,
        string calldata handle
    ) external;
}
</code></pre>
<h3 id="beacon-interface"><a class="header" href="#beacon-interface">Beacon Interface</a></h3>
<p>A beacon contract follows the same interface as the OpenZeppelin 4 <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/v4.0.0/contracts/proxy/beacon/IBeacon.sol">IBeacon</a>.
Updating the beacon logic address is left to the implementation of the beacon, but the OpenZeppelin 4 <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/v4.0.0/contracts/proxy/beacon/UpgradeableBeacon.sol">UpgradeableBeacon</a> is suggested.</p>
<pre><code class="language-solidity">/**
 * @dev This is the interface that {BeaconProxy} expects of its beacon.
 */
interface IBeacon {
    /**
     * @dev Must return an address that can be used as a delegate call target.
     *      This follows the interface from OpenZeppelin 4.0.0 [IBeacon](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/v4.0.0/contracts/proxy/beacon/IBeacon.sol)
     *
     * @return A contract address that implements the logic for the proxy
     */
    function implementation() external view returns (address);
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../Ethereum/Identifiers.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../Ethereum/Registry.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../Ethereum/Identifiers.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../Ethereum/Registry.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
