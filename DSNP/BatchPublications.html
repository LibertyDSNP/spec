<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Batch Publications - DSNP Specification</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "coal" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 800) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <a id="logo" href="https://www.dsnp.org/">
                    DSNP
                </a>
                <ol class="chapter"><li class="chapter-item affix "><a href="../index.html">Introduction</a></li><li class="chapter-item affix "><a href="../Roadmap.html">Roadmap</a></li><li class="chapter-item expanded "><a href="../DSNP/Overview.html">DSNP</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../DSNP/Identity.html">Identity</a></li><li class="chapter-item "><a href="../DSNP/Identifiers.html">Identifiers</a></li><li class="chapter-item "><a href="../DSNP/Graph.html">Graph</a></li><li class="chapter-item expanded "><a href="../DSNP/BatchPublications.html" class="active">Batch Publications</a></li><li class="chapter-item "><a href="../DSNP/Announcements.html">Announcements</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../DSNP/Types/Tombstone.html">Tombstone</a></li><li class="chapter-item "><a href="../DSNP/Types/GraphChange.html">Graph Change</a></li><li class="chapter-item "><a href="../DSNP/Types/Broadcast.html">Broadcast</a></li><li class="chapter-item "><a href="../DSNP/Types/Reply.html">Reply</a></li><li class="chapter-item "><a href="../DSNP/Types/Reaction.html">Reaction</a></li><li class="chapter-item "><a href="../DSNP/Types/Profile.html">Profile</a></li><li class="chapter-item "><a href="../DSNP/Types/Update.html">Update</a></li></ol></li><li class="chapter-item "><a href="../DSNP/Serializations.html">Serializations</a></li></ol></li><li class="chapter-item "><a href="../Implementations.html">DSNP Implementation Specs</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../Ethereum/Overview.html">EVM</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../Ethereum/Identity.html">Identity</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../Ethereum/Identifiers.html">Identifiers</a></li><li class="chapter-item "><a href="../Ethereum/IdentityFactory.html">Factory</a></li><li class="chapter-item "><a href="../Ethereum/Registry.html">Registry</a></li></ol></li><li class="chapter-item "><a href="../Ethereum/Publishing.html">Publishing</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../Ethereum/Validation.html">Validation</a></li></ol></li></ol></li></ol></li><li class="chapter-item "><a href="../ActivityContent/Overview.html">Activity Content</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../ActivityContent/Types/Note.html">Note</a></li><li class="chapter-item "><a href="../ActivityContent/Types/Profile.html">Profile</a></li><li class="chapter-item "><div>Associated Type</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../ActivityContent/Associated/Hash.html">Hash</a></li><li class="chapter-item "><a href="../ActivityContent/Associated/Location.html">Location</a></li><li class="chapter-item "><a href="../ActivityContent/Associated/Tag.html">Tag</a></li><li class="chapter-item "><a href="../ActivityContent/Associated/Attachments.html">Attachments</a></li></ol></li></ol></li><li class="chapter-item "><a href="../Reference/Glossary.html">Glossary</a></li><li class="chapter-item "><div>Draft Specifications</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../Draft/Archivists.html">Archivists</a></li></ol></li></ol>
                <div class="spacer"></div>
                <a href="https://www.dsnp.org/developer-portal/" class="nav-return">↩ Developer Portal</a>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Dark</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">DSNP Specification</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/LibertyDSNP/spec" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/LibertyDSNP/spec/blob/main/pages/DSNP/BatchPublications.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Type to search..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="batch-publications"><a class="header" href="#batch-publications">Batch Publications</a></h1>
<p>A Batch Publication is an <a href="https://github.com/apache/parquet-format">Apache Parquet</a> file with a collection of <a href="Announcements.html">Announcements</a>.</p>
<h2 id="implementation-requirements"><a class="header" href="#implementation-requirements">Implementation Requirements</a></h2>
<h3 id="discoverable"><a class="header" href="#discoverable">Discoverable</a></h3>
<p>Implementations MUST have publicly discoverable Batch Publications.</p>
<h3 id="validity"><a class="header" href="#validity">Validity</a></h3>
<p>Implementations MUST be able to validate the Parquet file contents.
Validity MUST be immutable.</p>
<h3 id="historical"><a class="header" href="#historical">Historical</a></h3>
<p>Implementations MUST retain proof of existence of a Batch Publication.</p>
<h3 id="transparent-chain-of-delegation"><a class="header" href="#transparent-chain-of-delegation">Transparent Chain of Delegation</a></h3>
<p>All Announcements in a Batch file MUST be able to be proven to be from or have a chain of delegation to the publisher of the Batch.</p>
<h2 id="file-requirements"><a class="header" href="#file-requirements">File Requirements</a></h2>
<p>Batch files are stored and transferred in Apache Parquet format.</p>
<ul>
<li>Batch files MUST match the spec for a single <a href="Announcements.html">Announcement Type</a>.</li>
<li>Batch files MUST have Bloom filters set in accordance with the Announcement Type Spec.</li>
<li>Batch files MUST have NO MORE THAN 128*1024 rows.</li>
</ul>
<h3 id="bloom-filter"><a class="header" href="#bloom-filter">Bloom Filter</a></h3>
<ul>
<li>A Bloom filter MUST be a <a href="https://github.com/apache/parquet-format/blob/apache-parquet-format-2.9.0/BloomFilter.md">Split Block Bloom filter</a>.</li>
<li>The false-positive rate MUST be 0.001.</li>
</ul>
<p>Calculation for filter bits is different and nearly a factor of 10 lower than for a standard Bloom filter:
128*1024 rows with a 0.001 false-positive rate results in around 29,000 bits for a Split Block Bloom filter.</p>
<p>Bloom filters are ONLY added to some fields.
See also <a href="Announcements.html">Announcement Types</a>.</p>
<h4 id="columns-with-bloom-filters"><a class="header" href="#columns-with-bloom-filters">Columns with Bloom Filters</a></h4>
<table><thead><tr><th>Column</th><th>Parquet Type</th></tr></thead><tbody>
<tr><td>contentHash</td><td><code>BYTE_ARRAY</code></td></tr>
<tr><td>emoji</td><td><code>BYTE_ARRAY</code></td></tr>
<tr><td>fromId</td><td><code>BYTE_ARRAY</code></td></tr>
<tr><td>inReplyTo</td><td><code>BYTE_ARRAY</code></td></tr>
<tr><td>objectId</td><td><code>BYTE_ARRAY</code></td></tr>
</tbody></table>
<h2 id="non-normative"><a class="header" href="#non-normative">Non-Normative</a></h2>
<h3 id="design-requirements"><a class="header" href="#design-requirements">Design Requirements</a></h3>
<p>Batch files need to be quickly and easily searchable.
Minimal storage size and fast, simple querying are preferred over guarantees of no false positives or advanced data manipulation and column relationships.
The files are parseable by client applications, web views, or browsers running pure JavaScript without a need to convert the format.</p>
<p>Applications need to know if a given Batch file has any information they are interested in without downloading the file first.</p>
<h3 id="why-parquet"><a class="header" href="#why-parquet">Why Parquet?</a></h3>
<ol>
<li>Parquet is a <strong>column-oriented format</strong>. Since DSNP Batch Message data will have a very small column-to-row ratio compared to a typical web application database, it makes sense to prefer a column-oriented format.</li>
<li>Parquet format <strong>has been field-tested under extreme network conditions</strong>. It has broad support in cloud storage solutions, with libraries in multiple languages.</li>
<li><strong>Bloom filters are already supported</strong> in the Parquet specification, which allows for fast and accurate searching (with caveats for proper configuration).</li>
<li><strong>Amazon S3 support</strong>: We anticipate that some Batch Announcers, and possibly Archivists, will store Batch files on Amazon S3. Amazon Athena also supports storage in Parquet, and its API supports SQL-like queries.</li>
<li>Parquet also <strong>allows references to the same column across files</strong>, which could enable multi-file querying in the future.</li>
<li>Parquet <strong>supports compression formats</strong> such as Brötli, which itself is already a browser standard and has a demonstrated improvement in compression speed and file size over older formats.</li>
<li>Parquet <strong>files can be transferred directly</strong> to clients, which can parse the files in the app or browser. No conversion to some serialization format is necessary. This eliminates an entire class of bugs and makes both fetching and querying faster.</li>
<li>Parquet <strong>uses schemas</strong>, which additionally reduces file size.</li>
</ol>
<h3 id="rejected-alternatives"><a class="header" href="#rejected-alternatives">Rejected Alternatives</a></h3>
<ol>
<li>Cassandra, RocksDB, CouchDB, MongoDB, and HBASE were rejected since DSNP data needs neither a database for storage nor the overhead of one. Each of these was designed for use cases ranging from somewhat to drastically different than the DSNP network.</li>
<li>JSON, BSON, and SQLite, while used for storage sometimes, are intended for serialization. They are schemaless, which results in redundant information and therefore a larger size than formats with schemas. They also don't support Bloom filters; instead, indexing would be required, or new batches would need to be downloaded entirely.  The exception is SQLite, which does support more advanced queries; however, it was designed for in-memory storage.</li>
</ol>
<h3 id="batch-validity-and-order"><a class="header" href="#batch-validity-and-order">Batch Validity and Order</a></h3>
<p>Batch validity is immutable and usually in part based on the validation of the delegation of authors listed inside the batch to the publisher.
Due to the nature of distributed systems, it is possible that a race condition occurs such that a user's delegation revocation presents before a Batch that contains a message from that user via the revoked delegate.
While those individual messages should be considered invalid, testing a historical window of some time is suggested before considering the entire batch invalid.
This is analogous to the idea of a <a href="https://en.bitcoin.it/wiki/Confirmation">confirmation time</a>, but only applies to the past instead of the future.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../DSNP/Graph.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../DSNP/Announcements.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../DSNP/Graph.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../DSNP/Announcements.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
